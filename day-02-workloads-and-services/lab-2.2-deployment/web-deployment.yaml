apiVersion: apps/v1
kind: Deployment
metadata:
  name: web-deployment
  labels:
    app: web
    component: deployment
spec:
  # DESIRED STATE: how many Pods we want
  replicas: 3

  # SELECTOR: how Deployment finds its Pods
  # Must match template.metadata.labels
  selector:
    matchLabels:
      app: web
      tier: frontend

  # STRATEGY: how to perform updates
  # RollingUpdate = gradual replacement (zero downtime)
  # Recreate = terminate all old Pods, then create new ones (downtime)
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxUnavailable: 25%  # Max Pods that can be down during update
      maxSurge: 25%        # Max extra Pods created during update

  # POD TEMPLATE: blueprint for Pods
  # Identical to ReplicaSet template
  template:
    metadata:
      labels:
        app: web
        tier: frontend
    spec:
      containers:
      - name: nginx
        image: nginx:1.27-alpine  # Change this to trigger rollout
        ports:
        - containerPort: 80
          name: http
        resources:
          requests:
            memory: "64Mi"
            cpu: "100m"
          limits:
            memory: "128Mi"
            cpu: "200m"
        livenessProbe:
          httpGet:
            path: /
            port: 80
          initialDelaySeconds: 5
          periodSeconds: 10
        readinessProbe:
          httpGet:
            path: /
            port: 80
          initialDelaySeconds: 3
          periodSeconds: 5

# HOW IT WORKS:
# 1. Deployment controller creates a ReplicaSet from the template
# 2. ReplicaSet creates Pods (just like Lab 2.1)
# 3. If you change spec.template (e.g., image), Deployment:
#    - Creates NEW ReplicaSet with updated template
#    - Gradually scales new ReplicaSet UP (0 → 3)
#    - Gradually scales old ReplicaSet DOWN (3 → 0)
#    - Result: rolling update with zero downtime
# 4. Old ReplicaSets kept for rollback (scaled to 0)

# TRY THIS:
# 1. Apply: kubectl apply -f web-deployment.yaml
# 2. Check: kubectl get deployment,replicaset,pods
# 3. Update image: kubectl set image deployment/web-deployment nginx=nginx:1.25-alpine
# 4. Watch rollout: kubectl rollout status deployment/web-deployment --watch
# 5. Check history: kubectl rollout history deployment/web-deployment
# 6. Rollback: kubectl rollout undo deployment/web-deployment
